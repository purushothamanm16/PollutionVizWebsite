<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PollutionViz - Policy Impact Dashboard</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:"#FF69B4",secondary:'#4CAF50'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32xl','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body {
  background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 50%, #fce7f3 100%);
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
}

:where([class^="ri-"])::before { content: "\f3c2"; }

.gradient-text {
background: linear-gradient(135deg, #FF69B4, #9C27B0, #4CAF50);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.glass-card {
background: rgba(255, 255, 255, 0.25);
backdrop-filter: blur(15px);
border: 1px solid rgba(255, 255, 255, 0.3);
transition: all 0.3s ease;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.glass-card:hover {
transform: translateY(-3px);
box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
background: rgba(255, 255, 255, 0.35);
border-color: rgba(255, 255, 255, 0.4);
}

.metric-card {
background: rgba(255, 255, 255, 0.4);
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.3);
transition: all 0.3s ease;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.metric-card:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
background: rgba(255, 255, 255, 0.5);
}

.timeline-line {
background: linear-gradient(90deg, #FF69B4, #4CAF50);
height: 4px;
box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
}

.timeline-dot {
background: linear-gradient(135deg, #FF69B4, #4CAF50);
box-shadow: 0 0 0 4px rgba(255, 105, 180, 0.2);
}

.floating-particles {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
overflow: hidden;
z-index: -1;
pointer-events: none;
}

.particle {
position: absolute;
border-radius: 50%;
background: linear-gradient(135deg, rgba(255, 105, 180, 0.1), rgba(76, 175, 80, 0.1));
box-shadow: 0 0 20px rgba(255, 105, 180, 0.15);
animation: float 15s infinite ease-in-out;
}

.input-focus {
transition: all 0.3s ease;
background: rgba(255, 255, 255, 0.6);
border: 1px solid rgba(255, 105, 180, 0.2);
}

.input-focus:focus {
border-color: rgba(255, 105, 180, 0.5);
box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.1);
background: rgba(255, 255, 255, 0.8);
outline: none;
}

@keyframes float {
0%, 100% {
transform: translateY(0) translateX(0);
}
25% {
transform: translateY(-30px) translateX(15px);
}
50% {
transform: translateY(-15px) translateX(30px);
}
75% {
transform: translateY(-30px) translateX(15px);
}
}

.loading-spinner {
width: 40px;
height: 40px;
border: 4px solid rgba(255, 255, 255, 0.3);
border-radius: 50%;
border-top-color: #FF69B4;
animation: spin 1s ease-in-out infinite;
margin: 0 auto;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

.logo-text {
font-weight: 700;
letter-spacing: -0.02em;
}

.btn-hover:hover {
transform: scale(1.05);
box-shadow: 0 0 25px rgba(255, 105, 180, 0.4);
}

.form-container {
display: flex;
flex-direction: column;
height: 100%;
min-height: 600px;
}

.form-content {
flex: 1;
display: flex;
flex-direction: column;
gap: 1.25rem;
}

.map-wrapper {
position: relative;
height: 100%;
min-height: 600px;
display: flex;
flex-direction: column;
}

.map-content {
flex: 1;
position: relative;
}

/* Leaflet map styling */
#map {
height: 100%;
width: 100%;
border-radius: 12px;
z-index: 1;
}

.leaflet-control-container {
z-index: 10;
}
</style>
</head>
<body class="text-gray-800">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div class="floating-particles">
<div class="particle" style="width: 30px; height: 30px; top: 10%; left: 10%; animation-delay: 0s;"></div>
<div class="particle" style="width: 20px; height: 20px; top: 20%; left: 20%; animation-delay: 1s;"></div>
<div class="particle" style="width: 25px; height: 25px; top: 30%; left: 30%; animation-delay: 2s;"></div>
<div class="particle" style="width: 15px; height: 15px; top: 40%; left: 40%; animation-delay: 3s;"></div>
<div class="particle" style="width: 35px; height: 35px; top: 50%; left: 50%; animation-delay: 4s;"></div>
<div class="particle" style="width: 22px; height: 22px; top: 60%; left: 60%; animation-delay: 5s;"></div>
<div class="particle" style="width: 18px; height: 18px; top: 70%; left: 70%; animation-delay: 6s;"></div>
<div class="particle" style="width: 28px; height: 28px; top: 80%; left: 80%; animation-delay: 7s;"></div>
</div>

<!-- Header -->
<header class="bg-white/20 backdrop-blur-sm border-b border-white/30 text-gray-800 py-4 px-6 flex items-center justify-between shadow-lg">
<div class="flex items-center">
<div class="w-10 h-10 flex items-center justify-center mr-3 bg-green-500/20 rounded-xl">
<i class="ri-earth-line ri-xl text-green-600"></i>
</div>
<h1 class="text-2xl logo-text text-gray-800">PollutionViz</h1>
</div>
<h1 class="text-2xl md:text-3xl font-bold gradient-text">Policy Simulator</h1>
<a href="index.html" class="bg-white/30 backdrop-blur-sm hover:bg-white/40 text-gray-800 px-4 py-2 rounded-full flex items-center transition-all duration-300 border border-white/40">
<i class="ri-home-line mr-2"></i>
<span class="hidden sm:inline">Home</span>
</a>
</header>

<div class="container mx-auto px-4 py-6">
<div class="flex flex-col lg:flex-row gap-6 min-h-[600px]">
<!-- Policy Input Section (Left) -->
<div class="lg:w-1/2">
<div class="glass-card rounded-2xl p-6 form-container">
<h2 class="text-xl font-semibold mb-6 text-gray-800">Policy Input</h2>
<div class="form-content">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Policy Title</label>
<input type="text" id="policyTitle" class="w-full px-4 py-3 rounded-xl input-focus" placeholder="Enter policy title">
</div>
<div class="flex-1">
<label class="block text-sm font-medium text-gray-700 mb-2">Policy Description</label>
<textarea id="policyDescription" class="w-full px-4 py-3 rounded-xl input-focus resize-none flex-1 min-h-[120px]" placeholder="Describe your policy details and implementation strategy"></textarea>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Selected Region</label>
<div id="selectedRegion" class="flex items-center bg-gray-100/60 p-3 rounded-xl text-gray-500">
<i class="ri-map-pin-line mr-2"></i>
<span>Select a state from the map</span>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Current Pollution Levels</label>
<div id="pollutionLevels" class="grid grid-cols-5 gap-2">
<div class="bg-gray-100/60 p-2 rounded-lg text-center">
<div class="text-xs text-gray-600 mb-1">PM2.5</div>
<div class="font-semibold text-gray-400 text-sm">--</div>
</div>
<div class="bg-gray-100/60 p-2 rounded-lg text-center">
<div class="text-xs text-gray-600 mb-1">PM10</div>
<div class="font-semibold text-gray-400 text-sm">--</div>
</div>
<div class="bg-gray-100/60 p-2 rounded-lg text-center">
<div class="text-xs text-gray-600 mb-1">NO₂</div>
<div class="font-semibold text-gray-400 text-sm">--</div>
</div>
<div class="bg-gray-100/60 p-2 rounded-lg text-center">
<div class="text-xs text-gray-600 mb-1">O₃</div>
<div class="font-semibold text-gray-400 text-sm">--</div>
</div>
<div class="bg-gray-100/60 p-2 rounded-lg text-center">
<div class="text-xs text-gray-600 mb-1">CO</div>
<div class="font-semibold text-gray-400 text-sm">--</div>
</div>
</div>
</div>
<div class="mt-6">
<button id="analyzeBtn" type="button" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300 btn-hover">
<div class="flex items-center justify-center">
<i class="ri-rocket-line mr-2"></i>
<span>Analyze Policy Impact</span>
</div>
</button>
</div>
</div>
</div>

<div id="loadingState" class="hidden glass-card rounded-2xl p-8 text-center">
<div class="loading-spinner mb-4"></div>
<p class="text-gray-700 font-medium">Analyzing policy impact...</p>
<p class="text-sm text-gray-600 mt-2">This may take a few moments</p>
</div>
</div>

<!-- Map Section (Right) -->
<div class="lg:w-1/2">
<div class="glass-card rounded-2xl p-6 map-wrapper">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-semibold text-gray-800">Interactive Map</h2>
<button id="refreshMap" class="bg-white/40 p-2 rounded-lg hover:bg-white/60 transition-colors">
<i class="ri-refresh-line"></i>
</button>
</div>
<div class="map-content">
<div id="map" class="rounded-xl overflow-hidden"></div>
</div>
</div>
</div>
</div>
</div>

<!-- Results Section (Initially Hidden) -->
<!-- Results Section (Initially Hidden) -->
<div id="resultsSection" class="hidden mt-8 space-y-6 px-4 max-w-7xl mx-auto">
<!-- Impact Metrics -->
<div class="glass-card rounded-2xl p-6">
<h2 class="text-xl font-semibold mb-4 text-gray-800">Impact Metrics</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
<div class="metric-card p-4 rounded-xl">
<div class="text-sm text-gray-600 mb-1">Air Quality Improvement</div>
<div id="aqiImprovement" class="text-3xl font-bold text-primary">--</div>
<div class="text-xs text-gray-500 mt-1">Expected reduction in pollutants</div>
</div>
<div class="metric-card p-4 rounded-xl">
<div class="text-sm text-gray-600 mb-1">Health Benefits</div>
<div id="healthBenefits" class="text-3xl font-bold text-green-500">--</div>
<div class="text-xs text-gray-500 mt-1">Reduced respiratory issues</div>
</div>
<div class="metric-card p-4 rounded-xl">
<div class="text-sm text-gray-600 mb-1">Estimated Cost</div>
<div id="estimatedCost" class="text-3xl font-bold text-blue-500">--</div>
<div class="text-xs text-gray-500 mt-1">Implementation over <span id="timeline">--</span></div>
</div>
<div class="metric-card p-4 rounded-xl">
<div class="text-sm text-gray-600 mb-1">Timeline</div>
<div class="text-3xl font-bold text-orange-500" id="timelineDuration">--</div>
<div class="text-xs text-gray-500 mt-1">Full implementation period</div>
</div>
</div>
</div>

<!-- Implementation Timeline -->
<div class="glass-card rounded-2xl p-6">
<h2 class="text-xl font-semibold mb-4 text-gray-800">Implementation Timeline</h2>
<div class="relative pt-8 pb-4">
<div class="timeline-line absolute top-12 left-0 w-full"></div>
<div class="flex justify-between relative">
<div class="w-1/3 px-2 text-center">
<div class="timeline-dot w-8 h-8 rounded-full flex items-center justify-center text-white mx-auto mb-2 relative z-10 text-sm font-bold">1</div>
<h3 class="font-semibold text-gray-800 text-sm">Short-term</h3>
<p class="text-xs text-gray-600">0-6 months</p>
<div class="mt-3 metric-card p-3 rounded-xl text-xs">
<p class="font-medium text-gray-800">Phase 1: Immediate Actions</p>
<ul id="shortTermSteps" class="text-xs text-gray-600 mt-2 list-disc list-inside text-left">
<li>--</li>
</ul>
</div>
</div>
<div class="w-1/3 px-2 text-center">
<div class="timeline-dot w-8 h-8 rounded-full flex items-center justify-center text-white mx-auto mb-2 relative z-10 text-sm font-bold">2</div>
<h3 class="font-semibold text-gray-800 text-sm">Medium-term</h3>
<p class="text-xs text-gray-600">6-18 months</p>
<div class="mt-3 metric-card p-3 rounded-xl text-xs">
<p class="font-medium text-gray-800">Phase 2: Infrastructure</p>
<ul id="mediumTermSteps" class="text-xs text-gray-600 mt-2 list-disc list-inside text-left">
<li>--</li>
</ul>
</div>
</div>
<div class="w-1/3 px-2 text-center">
<div class="timeline-dot w-8 h-8 rounded-full flex items-center justify-center text-white mx-auto mb-2 relative z-10 text-sm font-bold">3</div>
<h3 class="font-semibold text-gray-800 text-sm">Long-term</h3>
<p class="text-xs text-gray-600">18+ months</p>
<div class="mt-3 metric-card p-3 rounded-xl text-xs">
<p class="font-medium text-gray-800">Phase 3: Sustainable Solutions</p>
<ul id="longTermSteps" class="text-xs text-gray-600 mt-2 list-disc list-inside text-left">
<li>--</li>
</ul>
</div>
</div>
</div>
</div>
</div>

<!-- Pollutant Reduction Chart -->
<div class="glass-card rounded-2xl p-6">
<h2 class="text-xl font-semibold mb-4 text-gray-800">Pollutant Reduction</h2>
<div id="pollutantChart" class="w-full h-[350px] min-w-full"></div>
</div>

<!-- Population Impact -->
<div class="glass-card rounded-2xl p-6 mb-10">
<h2 class="text-xl font-semibold mb-4 text-gray-800">Population Impact</h2>
<div class="flex flex-col md:flex-row items-center gap-6">
<div class="md:w-1/3 flex justify-center">
<div class="relative w-40 h-40">
<svg viewBox="0 0 36 36" class="w-full h-full">
<path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e5e7eb" stroke-width="3" />
<path id="popCircle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 0" fill="none" stroke="url(#gradient)" stroke-width="3" stroke-dasharray="0, 100" />
<defs>
<linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
<stop offset="0%" stop-color="#FF69B4" />
<stop offset="100%" stop-color="#4CAF50" />
</linearGradient>
</defs>
</svg>
<div class="absolute inset-0 flex flex-col items-center justify-center">
<span id="populationPercent" class="text-2xl font-bold text-gray-800">--</span>
<span class="text-xs text-gray-600">Population Benefited</span>
</div>
</div>
</div>
<div class="md:w-2/3">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="metric-card p-4 rounded-xl">
<div class="text-sm text-gray-600">Total Population</div>
<div id="totalPopulation" class="text-xl font-bold text-gray-800">--</div>
</div>
<div class="metric-card p-4 rounded-xl">
<div class="text-sm text-gray-600">People Benefited</div>
<div id="totalBenefited" class="text-xl font-bold text-primary">--</div>
</div>
<div class="metric-card p-4 rounded-xl col-span-1 md:col-span-2">
<div class="text-sm text-gray-600 mb-3">Demographic Breakdown</div>
<div class="space-y-2">
<div class="flex items-center">
<div class="w-full bg-gray-200 rounded-full h-2">
<div id="urbanBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
</div>
<span id="urbanPercent" class="ml-2 text-sm text-gray-600 min-w-fit">Urban (--%)</span>
</div>
<div class="flex items-center">
<div class="w-full bg-gray-200 rounded-full h-2">
<div id="ruralBar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
</div>
<span id="ruralPercent" class="ml-2 text-sm text-gray-600 min-w-fit">Rural (--%)</span>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Health Impact -->
<div class="glass-card rounded-2xl p-6 mt-10">
<h2 class="text-xl font-semibold mb-4 text-gray-800">Health Impact</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
<div class="metric-card p-4 rounded-xl">
<div class="flex items-center mb-3">
<div class="w-8 h-8 flex items-center justify-center rounded-full bg-red-100 text-red-500 mr-3">
<i class="ri-heart-pulse-line"></i>
</div>
<span class="font-medium text-gray-800 text-sm">Respiratory Cases</span>
</div>
<div class="flex items-center">
<div id="respiratoryReduction" class="text-2xl font-bold text-red-500">--</div>
<div class="ml-2 text-sm text-gray-500">Reduction</div>
</div>
<p class="text-xs text-gray-500 mt-2">Reduced Respiratory cases</p>
</div>
<div class="metric-card p-4 rounded-xl">
<div class="flex items-center mb-3">
<div class="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-500 mr-3">
<i class="ri-money-dollar-circle-line"></i>
</div>
<span class="font-medium text-gray-800 text-sm">Healthcare Savings</span>
</div>
<div class="flex items-center">
<div id="healthcareSavings" class="text-2xl font-bold text-green-500">--</div>
<div class="ml-2 text-sm text-gray-500">Annually</div>
</div>
<p class="text-xs text-gray-500 mt-2">Reduced treatment costs</p>
</div>
<div class="metric-card p-4 rounded-xl">
<div class="flex items-center mb-3">
<div class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-500 mr-3">
<i class="ri-user-smile-line"></i>
</div>
<span class="font-medium text-gray-800 text-sm">Quality of Life</span>
</div>
<div class="flex items-center">
<div id="qualityOfLife" class="text-2xl font-bold text-blue-500">--</div>
<div class="ml-2 text-sm text-gray-500">Improvement</div>
</div>
<p class="text-xs text-gray-500 mt-2">Wellness metrics</p>
</div>
<div class="metric-card p-4 rounded-xl">
<div class="flex items-center mb-3">
<div class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-100 text-purple-500 mr-3">
<i class="ri-time-line"></i>
</div>
<span class="font-medium text-gray-800 text-sm">Long-term Benefits</span>
</div>
<div class="flex items-center">
<div id="lifeExpectancy" class="text-2xl font-bold text-purple-500">--</div>
<div class="ml-2 text-sm text-gray-500">Life expectancy</div>
</div>
<p class="text-xs text-gray-500 mt-2">20-year projection</p>
</div>
</div>
</div>
</div>
<!-- Footer -->
<footer class="mt-12 py-6 px-6 border-t border-white/30 bg-white/10">
<div class="max-w-6xl mx-auto text-center">
<div class="flex items-center justify-center space-x-3 mb-3">
<i class="ri-leaf-line text-green-600"></i>
<span class="logo-text text-base text-gray-800">PollutionViz</span>
</div>
<p class="text-gray-600 text-xs">
Making invisible pollution visible through advanced AR/VR and AI technology.
</p>
<p class="text-gray-500 text-xs mt-1">
© 2024 PollutionViz. All rights reserved.
</p>
</div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
  let map;
let geojsonLayer;
let selectedState = null;

document.addEventListener('DOMContentLoaded', function () {
  const analyzeBtn = document.getElementById('analyzeBtn');
  const loadingState = document.getElementById('loadingState');
  const resultsSection = document.getElementById('resultsSection');
  const policyTitle = document.getElementById('policyTitle');
  const policyDescription = document.getElementById('policyDescription');
  const selectedRegion = document.getElementById('selectedRegion');
  const refreshMapBtn = document.getElementById('refreshMap');

  initializeMap();

  function initializeMap() {
    map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    loadGeoJSON();
  }

  function loadGeoJSON() {
    fetch('geojson/india_states_full.geojson')
      .then(response => response.json())
      .then(data => {
        geojsonLayer = L.geoJSON(data, {
          style: getDefaultStyle,
          onEachFeature: function (feature, layer) {
            const props = feature.properties;
            const stateName = props.shapeName;

            if (!stateName) {
              console.warn("⚠️ No state name found for feature:", props);
              return;
            }

            layer.on('click', function () {
              const center = layer.getBounds().getCenter();
              console.log("✅ State clicked:", stateName);
              selectState(stateName, center);
            });

            layer.on('mouseover', function () {
              if (selectedState !== stateName) {
                layer.setStyle({
                  weight: 3,
                  color: '#FF69B4',
                  dashArray: '',
                  fillOpacity: 0.3
                });
              }
            });

            layer.on('mouseout', function (e) {
              if (selectedState !== stateName) {
                geojsonLayer.resetStyle(e.target);
              }
            });
          }
        }).addTo(map);
      })
      .catch(() => alert('Error loading map data.'));
  }

  function getDefaultStyle() {
    return {
      fillColor: '#ffffff',
      weight: 2,
      opacity: 1,
      color: '#666666',
      dashArray: '3',
      fillOpacity: 0.1
    };
  }

  function getSelectedStyle() {
    return {
      fillColor: '#ffffff',
      weight: 4,
      opacity: 1,
      color: '#FF69B4',
      dashArray: '',
      fillOpacity: 0.2
    };
  }

  function selectState(stateName, center) {
    selectedState = stateName;

    if (geojsonLayer) {
      geojsonLayer.eachLayer(function (layer) {
        const name = layer.feature.properties.NAME_1 || layer.feature.properties.name || layer.feature.properties.ST_NM;
        layer.setStyle(name === stateName ? getSelectedStyle() : getDefaultStyle());
      });
    }

    if (center) {
      fetchPollutionData(center.lat, center.lng);
    }
  }

  function fetchPollutionData(lat, lon) {
    fetch(`http://localhost:8000/aqi/aqi?lat=${lat}&lon=${lon}`)
      .then(res => res.json())
      .then(data => {
        const values = {
          pm25: data.pm25_ugm3 ?? "--",
          pm10: data.pm10_ugm3 ?? "--",
          no2: data.no2_ppb ?? "--",
          o3: data.o3_ugm3 ?? "--",
          co: data.co_ppb ?? "--"
        };

        const location = data.location ?? selectedState ?? "Unknown Location";
        selectedRegion.innerHTML = `
          <i class="ri-map-pin-line mr-2 text-blue-500"></i>
          <span class="text-blue-700 font-medium">${location}</span>
        `;
        selectedRegion.className = 'flex items-center bg-blue-50 p-3 rounded-xl border border-blue-200';

        const pollutionLevels = document.getElementById('pollutionLevels');
        const metrics = pollutionLevels.querySelectorAll('.font-semibold');

        metrics[0].textContent = values.pm25;
        metrics[1].textContent = values.pm10;
        metrics[2].textContent = values.no2;
        metrics[3].textContent = values.o3;
        metrics[4].textContent = values.co;

        metrics.forEach(metric => {
          metric.classList.remove('text-gray-400');
          metric.classList.add('text-blue-700');
        });
      })
      .catch(err => {
        console.error("Failed to fetch AQI data:", err);
        alert("Could not retrieve air quality data for this region.");
      });
  }

  refreshMapBtn.addEventListener('click', () => {
    if (map) {
      map.setView([20.5937, 78.9629], 5);
      selectedState = null;
      selectedRegion.innerHTML = `
        <i class="ri-map-pin-line mr-2"></i>
        <span>Select a state from the map</span>
      `;
      selectedRegion.className = 'flex items-center bg-gray-100/60 p-3 rounded-xl text-gray-500';

      const pollutionLevels = document.getElementById('pollutionLevels');
      for (let i = 0; i < pollutionLevels.children.length; i++) {
        const el = pollutionLevels.children[i];
        el.className = 'bg-gray-100/60 p-2 rounded-lg text-center';
        el.children[1].className = 'font-semibold text-gray-400 text-sm';
        el.children[1].textContent = '--';
      }

      if (geojsonLayer) {
        geojsonLayer.eachLayer(layer => layer.setStyle(getDefaultStyle()));
      }
    }
  });

  analyzeBtn.addEventListener('click', async () => {
    if (!policyTitle.value.trim() || !policyDescription.value.trim() || !selectedState) {
      alert('Please fill in all fields.');
      return;
    }

    loadingState.classList.remove('hidden');
    analyzeBtn.disabled = true;

    try {
      const data = await fetchPolicyImpactData(policyTitle.value, policyDescription.value, selectedState);
      updateDashboard(data);
      resultsSection.classList.remove('hidden');
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      alert("Error fetching data: " + err.message);
    } finally {
      loadingState.classList.add('hidden');
      analyzeBtn.disabled = false;
    }
  });

  function initChart() {
    const chartDom = document.getElementById('pollutantChart');
    if (!chartDom) return;

    const myChart = echarts.init(chartDom);
    const option = {
      tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
      legend: {
        data: ['Current Levels', 'After Policy Implementation'],
        bottom: 0
      },
      grid: { left: '3%', right: '4%', bottom: '15%', top: '3%', containLabel: true },
      xAxis: { type: 'category', data: ['PM2.5', 'PM10', 'NO₂', 'O₃', 'CO'] },
      yAxis: { type: 'value', name: 'Concentration' },
      series: [
        { name: 'Current Levels', type: 'bar', data: [187, 243, 86, 42, 1.8], itemStyle: { color: '#FF69B4' } },
        { name: 'After Policy Implementation', type: 'bar', data: [127, 165, 58, 30, 1.2], itemStyle: { color: '#4CAF50' } }
      ]
    };
    myChart.setOption(option);
    window.addEventListener('resize', () => myChart.resize());
  }

  // You can call initChart() here or after getting data, as needed.
  initChart();

  async function fetchPolicyImpactData(title, description, state) {
    const policy = encodeURIComponent(title.trim() + '. ' + description.trim());
    const location = state;
    const metrics = document.querySelectorAll('#pollutionLevels .font-semibold');
    const params = {
      policy,
      location,
      pm25: parseFloat(metrics[0].textContent) || 0,
      pm10: parseFloat(metrics[1].textContent) || 0,
      no2: parseFloat(metrics[2].textContent) || 0,
      o3: parseFloat(metrics[3].textContent) || 0,
      co: parseFloat(metrics[4].textContent) || 0
    };

    const query = new URLSearchParams(params).toString();
    const res = await fetch(`http://localhost:8000/ai/predict_policy?${query}`);
    if (!res.ok) throw new Error('Network response was not ok');
    const data = await res.json();
    return data;
  }

  function toTitleCase(str) {
    return str.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
  }
function updateDashboard(data) {
  // Impact Metrics
  document.getElementById('aqiImprovement').textContent = `${data.aqi_improvement_percent.toFixed(0)}%`;
  document.getElementById('healthBenefits').textContent = toTitleCase(data.health_benefits);
  document.getElementById('estimatedCost').textContent = data.estimated_cost_rupees;
  document.getElementById('timelineDuration').textContent = `${data.timeline_months}mo`;

  // Implementation Steps
  document.getElementById('shortTermSteps').innerHTML = data.short_term_steps.map(item => `<li>${item}</li>`).join('');
  document.getElementById('mediumTermSteps').innerHTML = data.medium_term_steps.map(item => `<li>${item}</li>`).join('');
  document.getElementById('longTermSteps').innerHTML = data.long_term_steps.map(item => `<li>${item}</li>`).join('');

  // Population Impact
  const pop = Number(data.total_population) || 0;
  const benefited = Number(data.total_benefited || 0);
  const percent = pop > 0 ? ((benefited / pop) * 100) : 0;

  // Animate circular progress
  const circle = document.getElementById("popCircle");
  if (circle) {
    const circumference = 100; // circumference approx for your SVG radius
    const progress = Math.min(percent, 100).toFixed(1); // cap at 100

    circle.setAttribute("stroke-dasharray", `${progress}, ${circumference}`);
    circle.setAttribute("stroke-dashoffset", circumference - progress);
  }

  // Update UI numbers
  document.getElementById('populationPercent').textContent = `${percent.toFixed(1)}%`;
  document.getElementById('totalPopulation').textContent = pop ? `${(pop / 1e6).toFixed(1)} Million` : '--';
  document.getElementById('totalBenefited').textContent = benefited ? `${(benefited / 1e6).toFixed(1)} Million` : '--';
  document.getElementById('urbanBar').style.width = `${data.urban_percent}%`;
  document.getElementById('ruralBar').style.width = `${data.rural_percent}%`;
  document.getElementById('urbanPercent').textContent = `Urban (${data.urban_percent}%)`;
  document.getElementById('ruralPercent').textContent = `Rural (${data.rural_percent}%)`;

  // Health Impact
  document.getElementById('respiratoryReduction').textContent = `-${data.respiratory_cases_reduction_percent}%`;
  document.getElementById('healthcareSavings').textContent = data.healthcare_savings_rupees;
  document.getElementById('qualityOfLife').textContent = `+${data.quality_of_life_increase_percent}%`;
  document.getElementById('lifeExpectancy').textContent = data.life_expectancy;

  // Show section and draw chart
  resultsSection.classList.remove('hidden');
  setTimeout(() => {
    updatePollutantChart(data.old_pollutants, data.new_pollutants);
  }, 200);
}
function updatePollutantChart(oldP = {}, newP = {}) {
  const chartDom = document.getElementById('pollutantChart');
  if (!chartDom) return;

  // Dispose existing chart instance if any
  if (echarts.getInstanceByDom(chartDom)) {
    echarts.getInstanceByDom(chartDom).dispose();
  }

  const chart = echarts.init(chartDom);
  const labels = ['pm25', 'pm10', 'no2', 'o3', 'co'];

  chart.setOption({
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
    legend: { data: ['Current Levels', 'After Policy'], bottom: 0 },
    grid: { left: '3%', right: '4%', bottom: '15%', top: '3%', containLabel: true },
    xAxis: { type: 'category', data: labels.map(x => x.toUpperCase()) },
    yAxis: { type: 'value', name: 'Concentration' },
    series: [
      {
        name: 'Current Levels',
        type: 'bar',
        data: labels.map(k => oldP[k]),
        itemStyle: { color: '#FF69B4' }
      },
      {
        name: 'After Policy',
        type: 'bar',
        data: labels.map(k => newP[k]),
        itemStyle: { color: '#4CAF50' }
      }
    ]
  });

  // Trigger resize after the element is visible/rendered
  setTimeout(() => chart.resize(), 300);

  // Also resize on window resize
  window.addEventListener('resize', () => chart.resize());
}
});
</script>
</body>
</html>
